\input{styles/page}
\usepackage{tikz}
\usepackage{paracol}

% Toggle finding background overlays.
\newif\iffindingstyle
\findingstyletrue
\newcommand{\enablefindingstyle}{\findingstyletrue}
\newcommand{\disablefindingstyle}{%
  \findingstylefalse%
  \ClearShipoutPictureBG%
}
\newenvironment{findingstyle}{\enablefindingstyle}{\disablefindingstyle}

% Sidebar layout defaults
\newlength{\pageleftbleed}
\setlength{\pageleftbleed}{0.4in}
\newcommand{\sidebarcolratio}{0.2}
\newlength{\sidebarcolwidth}
\newlength{\sidebarbleedwidth}
\newlength{\sidebarcontentshift}
\setlength{\sidebarcontentshift}{0.8\pageleftbleed}
\newlength{\sidebarstartoffset}
\setlength{\sidebarstartoffset}{0em}
\newlength{\sidebarborderwidth}
\setlength{\sidebarborderwidth}{2.5pt}
\newlength{\sidebartitlewidth}
\setlength{\sidebartitlewidth}{2.2pt}

% Configure sidebar layout values in one place.
\newcommand{\setsidebarlayout}[6]{%
  \renewcommand{\sidebarcolratio}{#1}%
  \setlength{\pageleftbleed}{#2}%
  \setlength{\sidebarcontentshift}{#3}%
  \setlength{\sidebarstartoffset}{#4}%
  \setlength{\sidebarborderwidth}{#5}%
  \setlength{\sidebartitlewidth}{#6}%
}

\newcommand{\sidebarstartmark}{\tikz[remember picture,overlay]\coordinate (sidebarstart) at (0,\sidebarstartoffset);}
\newcommand{\drawtitleline}{%
  \tikz[remember picture,overlay]%
    \draw[sidebarborder,line width=\sidebartitlewidth] (current page.west|-sidebarstart) -- (current page.east|-sidebarstart);%
}

% Finding page background gradient (applies below the title line on page 1)
\newlength{\findingbgoffset}
\setlength{\findingbgoffset}{2.1em}
\newcounter{findingstartpage}
\newcommand{\findingbgstartcoord}{%
  \ifnum\value{page}=\value{findingstartpage}\relax
    \coordinate (findingbgstart) at (current page.west|-sidebarstart);
  \else
    \coordinate (findingbgstart) at ([yshift=\findingbgoffset]current page.west|-textareatop);
  \fi
}
\newcommand{\drawpagebg}{%
  \iffindingstyle
    \AddToShipoutPictureBG{%
      \begin{tikzpicture}[remember picture,overlay]
        \findingbgstartcoord
        \shade[top color=findingGradientStart,bottom color=findingGradientEnd]
          (current page.west|-findingbgstart) rectangle (current page.south east);
      \end{tikzpicture}%
    }%
  \fi
}
\newcommand{\drawsidebarbg}{%
  \setlength{\sidebarcolwidth}{\dimexpr\sidebarcolratio\textwidth\relax}%
  \setlength{\sidebarbleedwidth}{\dimexpr\pageleftbleed+\sidebarcolwidth\relax}%
  \iffindingstyle
    \AddToShipoutPictureBG{%
      \begin{tikzpicture}[remember picture,overlay]
        \findingbgstartcoord
        \shade[top color=findingSidebarGradientStart,bottom color=findingSidebarGradientEnd]
          (current page.west|-findingbgstart) rectangle ([xshift=\sidebarbleedwidth]current page.south west);
        \draw[sidebarborder,line width=\sidebarborderwidth] ([xshift=\sidebarbleedwidth]current page.west|-findingbgstart) -- ([xshift=\sidebarbleedwidth]current page.south west);
      \end{tikzpicture}%
    }%
  \fi
}
\newcommand{\drawtitlemask}{%
  \iffindingstyle
    \AddToShipoutPictureBG*{%
      \begin{tikzpicture}[remember picture,overlay]
        \ifnum\value{page}=1\relax
          \fill[white] (current page.north west) rectangle (current page.west|-sidebarstart);
        \fi
      \end{tikzpicture}%
    }%
  \fi
}
